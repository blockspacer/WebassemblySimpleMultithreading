<html>

	<script>
		//var string = function(){/*
		//lol
		//*/}.toString().slice(13,-3)

		(async ()=>{
			
			//settings 				
			const path = 'test.wasm';
			const memory_init_pages = 4;
			const page_size = 0x10000;
			const heap_start = page_size * memory_init_pages;
			
			const memory = new WebAssembly.Memory( { initial: memory_init_pages,shared: true, maximum:20} );
			const table = new WebAssembly.Table({ initial: 1337, element: 'anyfunc' });
			
			// load wasm
			const response = await fetch( path );
			const raw_buffer = await response.arrayBuffer();
			const wasm_module = await WebAssembly.compile(raw_buffer)
			
			const imports = { };
			imports.env = { };
			imports.env.memoryBase = 0;
			imports.env.memory = memory;
			
			imports.env.tableBase = 0;
			imports.env.__indirect_function_table = table;

			var worker = new Worker("/worker.js");
			
			worker.onmessage = function(e) {
				console.log("Worker: " + e.data);
			};
			
			const instance = await new WebAssembly.Instance(wasm_module, imports );
			
			console.log( "WebAssembly::Instance" );
			console.log( "WebAssembly::Memory Size: %d Bytes" , memory.buffer.byteLength );
			console.log( "WebAssembly::Table Size: %d Entries" , table.length );
			console.log( "WebAssembly::__heap_base is @0x%s" , (instance.exports.__heap_base).value.toString(16));
			console.log( "WebAssembly::__data_end  is @0x%s" , (instance.exports.__data_end).value.toString(16));
			
			const index_to_read = 1
			const value = 1
			
			const adr =  instance.exports.set(index_to_read*4,value) // index_to_read * sizeof(int)
			console.log( "MainThread: first call" , adr );
			
			
			console.log( "MainThread: fist check" , new Uint32Array( imports.env.memory.buffer )[1] ) 			
			
			worker.postMessage(memory);
			
			console.log( "MainThread: After worker Call:" , new Uint32Array( imports.env.memory.buffer )[index_to_read] ) 
			
			setTimeout( () => { 			
				console.log( "MainThread: after 1 Sec:" , new Uint32Array( imports.env.memory.buffer )[index_to_read] ) 
			}, 1000 );
		
		})();
	
	
	</script>
</html>
 